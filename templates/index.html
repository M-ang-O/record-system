<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–∏—Å—Ç–µ–º–∞ –∑–∞–ø–∏—Å–∏ –¥–ª—è –≥—Ä—É–ø–ø—ã</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <div class="user-info">
                <span>–í—ã –≤–æ—à–ª–∏ –∫–∞–∫: <strong>{{ username }}</strong></span>
                {% if is_admin %}
                <span class="admin-badge">üëë –ê–î–ú–ò–ù</span>
                {% endif %}
                <a href="/logout" class="logout-btn">–í—ã–π—Ç–∏</a>
            </div>

            <h1>–°–∏—Å—Ç–µ–º–∞ –∑–∞–ø–∏—Å–∏ –¥–ª—è –≥—Ä—É–ø–ø—ã</h1>
            <p class="description">–ó–∞–ø–∏—Å—å –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –µ–∂–µ–¥–Ω–µ–≤–Ω–æ –≤ <span id="activationTime">18:00</span></p>

            <div class="share-link">
                <strong>–ü–æ–¥–µ–ª–∏—Ç–µ—Å—å —Å—Å—ã–ª–∫–æ–π —Å –æ–¥–Ω–æ–≥—Ä—É–ø–ø–Ω–∏–∫–∞–º–∏:</strong>
                <div id="shareLink">{{ request.url_root }}</div>
                <button onclick="copyLink()" class="copy-btn">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É</button>
            </div>
        </header>

        <!-- –ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å -->
        {% if is_admin %}
        <div class="admin-panel">
            <h2>üëë –ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</h2>

            <div class="admin-controls">
                <div class="control-group">
                    <label>–í—Ä–µ–º—è –æ—Ç–∫—Ä—ã—Ç–∏—è –∑–∞–ø–∏—Å–∏:</label>
                    <input type="number" id="adminHour" min="0" max="23" value="18" class="time-input">
                    <span>:</span>
                    <input type="number" id="adminMinute" min="0" max="59" value="0" class="time-input">
                    <button onclick="updateSettings()" class="save-btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—Ä–µ–º—è</button>
                </div>

                <div class="control-group">
                    <label>–°—Ç–∞—Ç—É—Å –∑–∞–ø–∏—Å–∏:</label>
                    <button id="toggleRegistration" onclick="toggleRegistration()" class="toggle-btn open">
                        –ó–∞–ø–∏—Å—å –æ—Ç–∫—Ä—ã—Ç–∞
                    </button>
                </div>

                <div class="control-group">
                    <button onclick="resetAllData()" class="danger-btn">üóëÔ∏è –°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ</button>
                    <button onclick="showUserManagement()" class="manage-btn">üë• –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</button>
                </div>
            </div>
        </div>
        {% endif %}

        <div class="button-section">
            <button id="recordButton" class="record-button" disabled>–ó–ê–ü–ò–°–ê–¢–¨–°–Ø</button>
        </div>

        <div id="timer" class="timer"></div>
        <div id="status" class="status"></div>

        <div id="debugInfo" class="debug-info" style="display: none;">
            <h3>–û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:</h3>
            <pre id="debugContent"></pre>
            <button onclick="forceActivate()" class="debug-btn">–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å</button>
        </div>

        <div class="table-section">
            <div class="table-header">
                <h2>–°–ø–∏—Å–æ–∫ –∑–∞–ø–∏—Å–∞–≤—à–∏—Ö—Å—è</h2>
                <div class="table-info">
                    <span id="userCount">–í—Å–µ–≥–æ: 0</span>
                    <button onclick="refreshData()" class="refresh-btn">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
                </div>
            </div>
            <table id="usersTable">
                <thead>
                    <tr>
                        <th class="position">‚Ññ</th>
                        <th class="user-name">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</th>
                        <th class="record-time">–í—Ä–µ–º—è –∑–∞–ø–∏—Å–∏</th>
                        {% if is_admin %}
                        <th class="actions">–î–µ–π—Å—Ç–≤–∏—è</th>
                        {% endif %}
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <tr>
                        <td colspan="{% if is_admin %}4{% else %}3{% endif %}" class="empty-table">–ó–∞–≥—Ä—É–∑–∫–∞...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ -->
    <div id="userManagementModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeUserManagement()">&times;</span>
            <h2>üë• –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</h2>
            <div id="usersList" class="users-list">
                <!-- –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –±—É–¥–µ—Ç –∑–¥–µ—Å—å -->
            </div>
        </div>
    </div>

    <div class="notification" id="notification"></div>

    <script>
        // –≠–ª–µ–º–µ–Ω—Ç—ã DOM
        const recordButton = document.getElementById('recordButton');
        const timerElement = document.getElementById('timer');
        const statusElement = document.getElementById('status');
        const tableBody = document.getElementById('tableBody');
        const userCountElement = document.getElementById('userCount');
        const notification = document.getElementById('notification');
        const activationTimeElement = document.getElementById('activationTime');

        // –ë–∞–∑–æ–≤—ã–π URL API
        const API_BASE = '';

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        function showNotification(message, isError = false) {
            notification.textContent = message;
            notification.className = 'notification show';
            if (isError) {
                notification.classList.add('error');
            }

            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è —Å—Å—ã–ª–∫–∏
        function copyLink() {
            const link = document.getElementById('shareLink').textContent;
            navigator.clipboard.writeText(link).then(() => {
                showNotification('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!');
            });
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞
        async function getStatus() {
            try {
                const response = await fetch(`${API_BASE}/api/status`);
                if (response.status === 401) {
                    window.location.href = '/login';
                    return null;
                }
                return await response.json();
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞:', error);
                return null;
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        async function getUsers() {
            try {
                const response = await fetch(`${API_BASE}/api/users`);
                if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
                return await response.json();
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:', error);
                showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö', true);
                return [];
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        async function addUser(name) {
            try {
                const response = await fetch(`${API_BASE}/api/users`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ name })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
                }

                return await response.json();
            } catch (error) {
                throw error;
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–π –∞–∫—Ç–∏–≤–∞—Ü–∏–∏
        async function forceActivate() {
            try {
                const response = await fetch(`${API_BASE}/api/debug/force_activate`, {
                    method: 'POST'
                });

                if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏');

                showNotification('–ö–Ω–æ–ø–∫–∞ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞!');
                await updateTimer();
            } catch (error) {
                showNotification(error.message, true);
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–∞–π–º–µ—Ä–∞
        async function updateTimer() {
            const status = await getStatus();
            if (!status) return;

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—Ç–ª–∞–¥–æ—á–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
            if (status.debug) {
                document.getElementById('debugInfo').style.display = 'block';
                document.getElementById('debugContent').textContent = JSON.stringify(status.debug, null, 2);
            }

            if (status.is_blocked) {
                recordButton.disabled = true;
                recordButton.textContent = '–ê–ö–ö–ê–£–ù–¢ –ó–ê–ë–õ–û–ö–ò–†–û–í–ê–ù';
                timerElement.textContent = '–í–∞—à –∞–∫–∫–∞—É–Ω—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º';
                timerElement.style.color = '#e74c3c';
                return;
            }

            if (status.is_active && status.is_registration_open) {
                recordButton.disabled = false;
                recordButton.classList.add('pulse');
                recordButton.textContent = '–ó–ê–ü–ò–°–ê–¢–¨–°–Ø';
                timerElement.textContent = '–ó–∞–ø–∏—Å—å –æ—Ç–∫—Ä—ã—Ç–∞!';
                statusElement.textContent = `–ó–∞–ø–∏—Å–∞–ª–æ—Å—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: ${status.total_users}`;
                statusElement.style.color = '#2ecc71';
            } else {
                recordButton.disabled = true;
                recordButton.classList.remove('pulse');
                recordButton.textContent = '–ó–ê–ü–ò–°–ê–¢–¨–°–Ø';

                if (!status.is_registration_open) {
                    timerElement.textContent = '–ó–∞–ø–∏—Å—å –≤—Ä–µ–º–µ–Ω–Ω–æ –∑–∞–∫—Ä—ã—Ç–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º';
                    timerElement.style.color = '#e74c3c';
                } else {
                    const hours = Math.floor(status.time_until_active / 3600);
                    const minutes = Math.floor((status.time_until_active % 3600) / 60);
                    const seconds = status.time_until_active % 60;

                    timerElement.textContent = `–î–æ –æ—Ç–∫—Ä—ã—Ç–∏—è –∑–∞–ø–∏—Å–∏: ${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                    timerElement.style.color = hours === 0 && minutes < 10 ? '#ffcc00' : 'white';
                }

                statusElement.textContent = `–ó–∞–ø–∏—Å–∞–ª–æ—Å—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: ${status.total_users}`;
                statusElement.style.color = 'white';
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã
        async function updateTable() {
            const users = await getUsers();

            tableBody.innerHTML = '';
            userCountElement.textContent = `–í—Å–µ–≥–æ: ${users.length}`;

            if (users.length === 0) {
                const colspan = {{ 4 if is_admin else 3 }};
                tableBody.innerHTML = `<tr><td colspan="${colspan}" class="empty-table">–ü–æ–∫–∞ –Ω–∏–∫—Ç–æ –Ω–µ –∑–∞–ø–∏—Å–∞–ª—Å—è</td></tr>`;
                return;
            }

            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ —Ç–∞–±–ª–∏—Ü–µ
            users.forEach((user, index) => {
                const row = document.createElement('tr');

                const positionCell = document.createElement('td');
                positionCell.className = 'position';
                positionCell.textContent = index + 1;

                const nameCell = document.createElement('td');
                nameCell.className = 'user-name';
                nameCell.textContent = user.name;

                const timeCell = document.createElement('td');
                timeCell.className = 'record-time';
                timeCell.textContent = new Date(user.time).toLocaleTimeString();

                row.appendChild(positionCell);
                row.appendChild(nameCell);
                row.appendChild(timeCell);

                {% if is_admin %}
                const actionsCell = document.createElement('td');
                actionsCell.className = 'actions';

                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-btn';
                deleteBtn.textContent = 'üóëÔ∏è';
                deleteBtn.title = '–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å';
                deleteBtn.onclick = () => deleteRecord(user.id);

                actionsCell.appendChild(deleteBtn);
                row.appendChild(actionsCell);
                {% endif %}

                tableBody.appendChild(row);
            });
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –Ω–∞–∂–∞—Ç–∏—è –Ω–∞ –∫–Ω–æ–ø–∫—É
        async function handleRecord() {
            if (recordButton.disabled) return;

            const userName = prompt('–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è –¥–ª—è –∑–∞–ø–∏—Å–∏:');

            if (!userName || userName.trim() === '') {
                alert('–ò–º—è –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º!');
                return;
            }

            try {
                recordButton.disabled = true;
                recordButton.textContent = '–ó–ê–ü–ò–°–¨...';

                const result = await addUser(userName.trim());

                showNotification(`–í—ã —É—Å–ø–µ—à–Ω–æ –∑–∞–ø–∏—Å–∞–ª–∏—Å—å –ø–æ–¥ –Ω–æ–º–µ—Ä–æ–º ${result.id}!`);

                // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ
                await updateTable();
                await updateTimer();

            } catch (error) {
                showNotification(error.message, true);
            } finally {
                recordButton.disabled = false;
                recordButton.textContent = '–ó–ê–ü–ò–°–ê–¢–¨–°–Ø';
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
        async function refreshData() {
            await updateTable();
            await updateTimer();
            showNotification('–î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã!');
        }

        // –ê–¥–º–∏–Ω —Ñ—É–Ω–∫—Ü–∏–∏
        async function updateSettings() {
            const hour = parseInt(document.getElementById('adminHour').value);
            const minute = parseInt(document.getElementById('adminMinute').value);

            try {
                const response = await fetch(`${API_BASE}/api/admin/settings`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        activation_hour: hour,
                        activation_minute: minute
                    })
                });

                if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫');

                showNotification('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!');
                await updateTimer();
            } catch (error) {
                showNotification(error.message, true);
            }
        }

        async function toggleRegistration() {
            const button = document.getElementById('toggleRegistration');
            const isCurrentlyOpen = button.classList.contains('open');

            try {
                const response = await fetch(`${API_BASE}/api/admin/settings`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        is_registration_open: !isCurrentlyOpen
                    })
                });

                if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–ø–∏—Å–∏');

                if (isCurrentlyOpen) {
                    button.classList.remove('open');
                    button.classList.add('closed');
                    button.textContent = '–ó–∞–ø–∏—Å—å –∑–∞–∫—Ä—ã—Ç–∞';
                } else {
                    button.classList.remove('closed');
                    button.classList.add('open');
                    button.textContent = '–ó–∞–ø–∏—Å—å –æ—Ç–∫—Ä—ã—Ç–∞';
                }

                showNotification(`–ó–∞–ø–∏—Å—å ${isCurrentlyOpen ? '–∑–∞–∫—Ä—ã—Ç–∞' : '–æ—Ç–∫—Ä—ã—Ç–∞'}!`);
                await updateTimer();
            } catch (error) {
                showNotification(error.message, true);
            }
        }

        async function deleteRecord(recordId) {
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–ø–∏—Å—å?')) return;

            try {
                const response = await fetch(`${API_BASE}/api/admin/records/${recordId}`, {
                    method: 'DELETE'
                });

                if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∑–∞–ø–∏—Å–∏');

                showNotification('–ó–∞–ø–∏—Å—å —É–¥–∞–ª–µ–Ω–∞!');
                await updateTable();
            } catch (error) {
                showNotification(error.message, true);
            }
        }

        async function resetAllData() {
            if (!confirm('–í–ù–ò–ú–ê–ù–ò–ï! –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–±—Ä–æ—Å–∏—Ç—å –í–°–ï –¥–∞–Ω–Ω—ã–µ? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) return;

            try {
                const response = await fetch(`${API_BASE}/api/admin/reset`, {
                    method: 'POST'
                });

                if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ —Å–±—Ä–æ—Å–∞ –¥–∞–Ω–Ω—ã—Ö');

                showNotification('–í—Å–µ –¥–∞–Ω–Ω—ã–µ —Å–±—Ä–æ—à–µ–Ω—ã!');
                await updateTable();
                await updateTimer();
            } catch (error) {
                showNotification(error.message, true);
            }
        }

        async function showUserManagement() {
            try {
                const response = await fetch(`${API_BASE}/api/admin/users`);
                if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π');

                const users = await response.json();
                const modal = document.getElementById('userManagementModal');
                const usersList = document.getElementById('usersList');

                usersList.innerHTML = users.map(user => `
                    <div class="user-item ${user.is_blocked ? 'blocked' : ''}">
                        <div class="user-info">
                            <strong>${user.username}</strong>
                            <span>–ó–∞–ø–∏—Å–µ–π: ${user.records_count}</span>
                            <span class="status ${user.is_blocked ? 'blocked' : 'active'}">
                                ${user.is_blocked ? 'üî¥ –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω' : 'üü¢ –ê–∫—Ç–∏–≤–µ–Ω'}
                            </span>
                        </div>
                        <div class="user-actions">
                            ${user.is_blocked ?
                                `<button onclick="unblockUser('${user.username}')" class="unblock-btn">–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å</button>` :
                                `<button onclick="blockUser('${user.username}')" class="block-btn">–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å</button>`
                            }
                        </div>
                    </div>
                `).join('');

                modal.style.display = 'block';
            } catch (error) {
                showNotification(error.message, true);
            }
        }

        function closeUserManagement() {
            document.getElementById('userManagementModal').style.display = 'none';
        }

        async function blockUser(username) {
            try {
                const response = await fetch(`${API_BASE}/api/admin/users/${username}/block`, {
                    method: 'POST'
                });

                if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');

                showNotification(`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${username} –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω!`);
                closeUserManagement();
            } catch (error) {
                showNotification(error.message, true);
            }
        }

        async function unblockUser(username) {
            try {
                const response = await fetch(`${API_BASE}/api/admin/users/${username}/unblock`, {
                    method: 'POST'
                });

                if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');

                showNotification(`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${username} —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω!`);
                closeUserManagement();
            } catch (error) {
                showNotification(error.message, true);
            }
        }

        // –ù–∞–∑–Ω–∞—á–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏—è
        recordButton.addEventListener('click', handleRecord);

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        async function init() {
            await updateTable();
            await updateTimer();

            // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –∞–¥–º–∏–Ω–∞
            {% if is_admin %}
            try {
                const response = await fetch(`${API_BASE}/api/admin/settings`);
                if (response.ok) {
                    const settings = await response.json();
                    document.getElementById('adminHour').value = settings.activation_hour;
                    document.getElementById('adminMinute').value = settings.activation_minute;

                    const toggleBtn = document.getElementById('toggleRegistration');
                    if (settings.is_registration_open) {
                        toggleBtn.classList.add('open');
                        toggleBtn.textContent = '–ó–∞–ø–∏—Å—å –æ—Ç–∫—Ä—ã—Ç–∞';
                    } else {
                        toggleBtn.classList.add('closed');
                        toggleBtn.textContent = '–ó–∞–ø–∏—Å—å –∑–∞–∫—Ä—ã—Ç–∞';
                    }
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫:', error);
            }
            {% endif %}

            // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–π–º–µ—Ä –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É
            setInterval(updateTimer, 1000);

            // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–±–ª–∏—Ü—É –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥
            setInterval(updateTable, 10000);
        }

        // –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
        init();

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
        window.onclick = function(event) {
            const modal = document.getElementById('userManagementModal');
            if (event.target === modal) {
                closeUserManagement();
            }
        }
    </script>
</body>
</html>