<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–∏—Å—Ç–µ–º–∞ –∑–∞–ø–∏—Å–∏ –¥–ª—è –≥—Ä—É–ø–ø—ã</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <h1>–°–∏—Å—Ç–µ–º–∞ –∑–∞–ø–∏—Å–∏ –¥–ª—è –≥—Ä—É–ø–ø—ã</h1>
            <p class="description">–ó–∞–ø–∏—Å—å –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –µ–∂–µ–¥–Ω–µ–≤–Ω–æ –≤ 18:00</p>
            <div class="share-link">
                <strong>–ü–æ–¥–µ–ª–∏—Ç–µ—Å—å —Å—Å—ã–ª–∫–æ–π —Å –æ–¥–Ω–æ–≥—Ä—É–ø–ø–Ω–∏–∫–∞–º–∏:</strong>
                <div id="shareLink">{{ request.url }}</div>
                <button onclick="copyLink()" class="copy-btn">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É</button>
            </div>
        </header>

        <div class="button-section">
            <button id="recordButton" class="record-button" disabled>–ó–ê–ü–ò–°–ê–¢–¨–°–Ø</button>
        </div>

        <div id="timer" class="timer"></div>
        <div id="status" class="status"></div>

        <div class="table-section">
            <div class="table-header">
                <h2>–°–ø–∏—Å–æ–∫ –∑–∞–ø–∏—Å–∞–≤—à–∏—Ö—Å—è</h2>
                <div class="table-info">
                    <span id="userCount">–í—Å–µ–≥–æ: 0</span>
                    <button onclick="refreshData()" class="refresh-btn">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
                </div>
            </div>
            <table id="usersTable">
                <thead>
                    <tr>
                        <th class="position">‚Ññ</th>
                        <th class="user-name">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</th>
                        <th class="record-time">–í—Ä–µ–º—è –∑–∞–ø–∏—Å–∏</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <tr>
                        <td colspan="3" class="empty-table">–ó–∞–≥—Ä—É–∑–∫–∞...</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- –ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å (–¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è) -->
        <div class="admin-panel">
            <h3>–ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å</h3>
            <input type="password" id="resetPassword" placeholder="–ü–∞—Ä–æ–ª—å –¥–ª—è —Å–±—Ä–æ—Å–∞">
            <button onclick="resetData()" class="reset-btn">–°–±—Ä–æ—Å–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
        </div>
    </div>

    <div class="notification" id="notification"></div>

    <script>
        // –≠–ª–µ–º–µ–Ω—Ç—ã DOM
        const recordButton = document.getElementById('recordButton');
        const timerElement = document.getElementById('timer');
        const statusElement = document.getElementById('status');
        const tableBody = document.getElementById('tableBody');
        const userCountElement = document.getElementById('userCount');
        const notification = document.getElementById('notification');

        // –ë–∞–∑–æ–≤—ã–π URL API
        const API_BASE = '';

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        function showNotification(message, isError = false) {
            notification.textContent = message;
            notification.className = 'notification show';
            if (isError) {
                notification.classList.add('error');
            }

            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è —Å—Å—ã–ª–∫–∏
        function copyLink() {
            const link = document.getElementById('shareLink').textContent;
            navigator.clipboard.writeText(link).then(() => {
                showNotification('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!');
            });
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞
        async function getStatus() {
            try {
                const response = await fetch(`${API_BASE}/api/status`);
                return await response.json();
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞:', error);
                return null;
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        async function getUsers() {
            try {
                const response = await fetch(`${API_BASE}/api/users`);
                if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
                return await response.json();
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:', error);
                showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö', true);
                return [];
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        async function addUser(name) {
            try {
                const response = await fetch(`${API_BASE}/api/users`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ name })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
                }

                return await response.json();
            } catch (error) {
                throw error;
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–∞–π–º–µ—Ä–∞
        async function updateTimer() {
            const status = await getStatus();
            if (!status) return;

            if (status.is_active) {
                recordButton.disabled = false;
                recordButton.classList.add('pulse');
                timerElement.textContent = '–ó–∞–ø–∏—Å—å –æ—Ç–∫—Ä—ã—Ç–∞!';
                statusElement.textContent = `–ó–∞–ø–∏—Å–∞–ª–æ—Å—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: ${status.total_users}`;
                statusElement.style.color = '#2ecc71';
            } else {
                recordButton.disabled = true;
                recordButton.classList.remove('pulse');

                const hours = Math.floor(status.time_until_active / 3600);
                const minutes = Math.floor((status.time_until_active % 3600) / 60);
                const seconds = status.time_until_active % 60;

                timerElement.textContent = `–î–æ –æ—Ç–∫—Ä—ã—Ç–∏—è –∑–∞–ø–∏—Å–∏: ${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                statusElement.textContent = `–ó–∞–ø–∏—Å–∞–ª–æ—Å—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: ${status.total_users}`;
                statusElement.style.color = 'white';

                // –ï—Å–ª–∏ –æ—Å—Ç–∞–ª–æ—Å—å –º–µ–Ω–µ–µ 10 –º–∏–Ω—É—Ç, –º–µ–Ω—è–µ–º —Ü–≤–µ—Ç —Ç–∞–π–º–µ—Ä–∞
                if (hours === 0 && minutes < 10) {
                    timerElement.style.color = '#ffcc00';
                }
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã
        async function updateTable() {
            const users = await getUsers();

            tableBody.innerHTML = '';
            userCountElement.textContent = `–í—Å–µ–≥–æ: ${users.length}`;

            if (users.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="3" class="empty-table">–ü–æ–∫–∞ –Ω–∏–∫—Ç–æ –Ω–µ –∑–∞–ø–∏—Å–∞–ª—Å—è</td></tr>';
                return;
            }

            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ —Ç–∞–±–ª–∏—Ü–µ
            users.forEach((user, index) => {
                const row = document.createElement('tr');

                const positionCell = document.createElement('td');
                positionCell.className = 'position';
                positionCell.textContent = index + 1;

                const nameCell = document.createElement('td');
                nameCell.className = 'user-name';
                nameCell.textContent = user.name;

                const timeCell = document.createElement('td');
                timeCell.className = 'record-time';
                timeCell.textContent = new Date(user.time).toLocaleTimeString();

                row.appendChild(positionCell);
                row.appendChild(nameCell);
                row.appendChild(timeCell);

                tableBody.appendChild(row);
            });
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –Ω–∞–∂–∞—Ç–∏—è –Ω–∞ –∫–Ω–æ–ø–∫—É
        async function handleRecord() {
            if (recordButton.disabled) return;

            const userName = prompt('–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è:');

            if (!userName || userName.trim() === '') {
                alert('–ò–º—è –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º!');
                return;
            }

            try {
                recordButton.disabled = true;
                recordButton.textContent = '–ó–ê–ü–ò–°–¨...';

                const result = await addUser(userName.trim());

                showNotification(`–í—ã —É—Å–ø–µ—à–Ω–æ –∑–∞–ø–∏—Å–∞–ª–∏—Å—å –ø–æ–¥ –Ω–æ–º–µ—Ä–æ–º ${result.id}!`);

                // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ
                await updateTable();
                await updateTimer();

            } catch (error) {
                showNotification(error.message, true);
            } finally {
                recordButton.disabled = false;
                recordButton.textContent = '–ó–ê–ü–ò–°–ê–¢–¨–°–Ø';
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
        async function refreshData() {
            await updateTable();
            await updateTimer();
            showNotification('–î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã!');
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–±—Ä–æ—Å–∞ –¥–∞–Ω–Ω—ã—Ö (–∞–¥–º–∏–Ω)
        async function resetData() {
            const password = document.getElementById('resetPassword').value;
            if (!password) {
                alert('–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/reset`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ password })
                });

                if (!response.ok) {
                    throw new Error('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å');
                }

                showNotification('–î–∞–Ω–Ω—ã–µ —Å–±—Ä–æ—à–µ–Ω—ã!');
                document.getElementById('resetPassword').value = '';
                await refreshData();
            } catch (error) {
                showNotification(error.message, true);
            }
        }

        // –ù–∞–∑–Ω–∞—á–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏—è
        recordButton.addEventListener('click', handleRecord);

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        async function init() {
            await updateTable();
            await updateTimer();

            // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–π–º–µ—Ä –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É
            setInterval(updateTimer, 1000);

            // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–±–ª–∏—Ü—É –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥
            setInterval(updateTable, 10000);
        }

        // –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
        init();
    </script>
</body>
</html>